name: Deploy2Staging

on:
  pull_request:
    branches: [master]
    types: [labeled]


env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_STAGING_CLUSTER: ${{ secrets.GKE_STAGING_CLUSTER }}    # TODO: update to cluster name
  GKE_ZONE: ${{ secrets.GKE_ZONE }}   # TODO: update to cluster zone
  SOURCE_BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
  GITHUB_TOKEN: ${{ secrets.GIHUB_PAT }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  PR_NUMBER: ${{ github.event.pull_request.number }}

jobs:

  sonarcloud:
    runs-on: ubuntu-latest
    outputs:
      SONAR_STATUS: ${{ steps.sonar.outputs.SONAR_STATUS }}
    steps:
    - uses: actions/checkout@v2
      with:
        # Disabling shallow clone is recommended for improving relevancy of reporting
        fetch-depth: 0
    - name: Sonar Cloud Quality Check
      id: sonar
      run: |-
        STATUS=`curl -u $SONAR_TOKEN: https://sonarcloud.io/api/qualitygates/project_status\?projectKey\=shopuptech_ss2\&pullRequest\=$PR_NUMBER | jq -r '.projectStatus.status'`
        echo $STATUS
        echo "SONAR_STATUS=$STATUS" >> $GITHUB_OUTPUT
        if [[ ! $STATUS == 'OK' ]] ;then
        exit 1
        fi

  docker-build:
    name: Setup, Build, Publish, and Deploy to staging
    needs: [ sonarcloud ]
    if: ${{ github.event.label.name == 'Ok to deploy in staging' }}
    uses: shopuptech/shopup-cicd-git-actions/.github/workflows/build-docker.yml@master
    with:
      BUILD_NAME: "ss2"
      DOCKER_FILE_PATH: "docker/Dockerfile"
      IMAGE_TAG: ${{ github.event.pull_request.head.ref }}-${{ github.run_number }}
      IMAGE_PATH: "gcr.io/voonik-tech/vnkshopup/ss2"
      WORKLOAD_PROVIDER: "projects/144345706419/locations/global/workloadIdentityPools/github-actions/providers/github"
      SERVICE_ACCOUNT: "circleci@voonik-tech.iam.gserviceaccount.com"
    secrets:
      BUILD_ARG: --build-arg GITHUB_TOKEN="${{secrets.GIHUB_PAT}}"

  update-proto-config:
    needs: docker-build
    uses: shopuptech/shopup-cicd-git-actions/.github/workflows/update-proto-config.yml@master
    with:
      GOCONNECT_DIRECTORIES: 'ss2,health,app_preference_service'
      NAMESPACE: "mokam"
      PB_FILE_NAME: "supplier.pb"
      PROTO_BIN_NAME: "ss2-proto-bin"
      LOCATION: "asia-southeast1"
      CLUSTER_NAME: "mokam-stg-autopilot"
      WORKLOAD_PROVIDER: "projects/144345706419/locations/global/workloadIdentityPools/github-actions/providers/github"
      SERVICE_ACCOUNT: "circleci@voonik-tech.iam.gserviceaccount.com"
    secrets:
      ACCESS_TOKEN: ${{ secrets.GIHUB_PAT}}

  deploy-staging:
    needs: [ docker-build,update-proto-config ]
    uses: shopuptech/shopup-cicd-git-actions/.github/workflows/go-deployment.yml@go-deploy
    with:
      APP_NAME: "ss2"
      IMAGE_TAG: ${{ github.event.pull_request.head.ref }}-${{ github.run_number }}
      valueFile: "charts/shopup/ss2/values-autopilot-stage.yaml"
      customValues: ${{ needs.update-proto-config.outputs.GOCONNECT_SERVICE_NAMES }}
    secrets:
      GIHUB_PAT: ${{ secrets.GIHUB_PAT }}

  integration-tests:
    needs: deploy-staging
    uses: shopuptech/integration-tests/.github/workflows/integration-tests.yml@master
    secrets: inherit
    with:
      TEST_SUITE: ss2.smoke
